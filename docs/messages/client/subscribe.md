# Client Subscribe Message

Sent by client to server right after establishing a connection. New clients must authenticate themselves when subscribing to any blockchain events via a signature.

## Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "type": {
      "type": "string",
      "enum": ["subscribe"]
    },
    "topics": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "blockchain": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "network": {
                "type": "string"
              }
            },
            "required": ["name", "network"]
          }
          /* <blockchain specific fields> */
        },
        "required": ["blockchain"]
      }
    },
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "signature": {
      "type": "string",
      "pattern": "^[A-Za-z0-9+/=]*$"
    }
  },
  "required": ["type", "topics", "timestamp", "signature"],
  "additionalProperties": false
}
```

The `signature` field is generated by signing a SHA256 HMAC hashed string. The prehash string is constructed by concatenating the subscribed `blockchains` + `timestamp`.

> ℹ️ **Remark**
> For subscribing to multiple blockchains, the prehash string must be formated as `<blockchain.name>.<blockchain.network>+<blockchain.name>.<blockchain.network>`, for example:
> `cardano.mainnet+bitcoin.mainnet+ethereum.mainnet`.

Apply a SHA256 HMAC using either the payment signing key or staking signing key, and then base64-encode it as final payload within the initial message. Pass the output of this SHA256 HMAC to the signature field.

The signature verifies ownership of the private key, whose corresponding public key is used to filter relevant block transactions.

## Subscribe Example

```json
{
  "type": "subscribe",
  "topics": [
    {
      "blockchain": { "name": "cardano", "network": "mainnet" },
      "credentials": {
        "internal_payment_vkey_hash": "", // hex
        "external_payment_vkey_hash": "", // hex
        "stake_vkey_hash": "" // hex
      },
      "public_key": "public_key_example",
      "signature": "OGNiOWIyNGVjOTMxZmY3N2MzYjQxOTY3OWE0YTcwMzczZmVkZmIxNDZmMDE0ODk0Nzg4YjUxMmIzMjE4MDdiYw==" // base64
    }
  ],
  "timestamp": "2024-06-27T12:34:56Z"
}
```

## Subscription Object

The subscription object is blockchain specific, because there are different networks, credentials or other fields required. Below we list the currently supported subcriptions:

### Cardano

```json
{
  "blockchain": {
    "name": "cardano",
    "network": {
      "type": "string",
      "enum": ["mainnet", "preprod", "preview"]
    }
  },
  "credentials": {
    "type": "object",
    "properties": {
      "internal_payment_vkey_hash": {
        "type": "string",
        "pattern": "^[0-9a-fA-F]*$"
      },
      "external_payment_vkey_hash": {
        "type": "string",
        "pattern": "^[0-9a-fA-F]*$"
      },
      "stake_vkey_hash": {
        "type": "string",
        "pattern": "^[0-9a-fA-F]*$"
      }
    },
    "required": [
      "internal_payment_vkey_hash",
      "external_payment_vkey_hash",
      "stake_vkey_hash"
    ]
  },
  "public_key": {
    "type": "string"
  },
  "signature": {
    "type": "string",
    "pattern": "^[A-Za-z0-9+/=]*$"
  },
  "required": ["blockchain", "credentials", "public_key", "signature"]
}
```
